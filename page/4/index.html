<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blueinyou.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Paul C&#39;s Blog">
<meta property="og:url" content="https://blueinyou.com/page/4/index.html">
<meta property="og:site_name" content="Paul C&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Paul C">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blueinyou.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Paul C's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Paul C's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">To be funny,to grow up!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/CTF/Nepctf01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/CTF/Nepctf01/" class="post-title-link" itemprop="url">Win_Rev01</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-08-10 11:00:12" itemprop="dateCreated datePublished" datetime="2023-08-10T11:00:12+08:00">2023-08-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-18 21:55:22" itemprop="dateModified" datetime="2023-08-18T21:55:22+08:00">2023-08-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="九龙拉棺"><a href="#九龙拉棺" class="headerlink" title="九龙拉棺"></a>九龙拉棺</h2><p><img src="/categories/CTF/Nepctf01/1691764840274.png" alt="1691764840274"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/CTF/rev02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/CTF/rev02/" class="post-title-link" itemprop="url">SYCTF2306 babyThread题解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-06 14:19:49 / Modified: 22:13:04" itemprop="dateCreated datePublished" datetime="2023-08-06T14:19:49+08:00">2023-08-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="本题难点"><a href="#本题难点" class="headerlink" title="本题难点"></a>本题难点</h2><p>1.这道题要给线程下断点，</p>
<p>2.而且还要跳过一个IsDebuggerPresent的反调试，</p>
<p>3.在进入线程后，输入阶段也有一个跳转需要修改。</p>
<h2 id="静态反汇编，"><a href="#静态反汇编，" class="headerlink" title="静态反汇编，"></a>静态反汇编，</h2><p>一路跟踪跳转关系，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Main_func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  sub_41141A();                                 <span class="comment">// 给函数指针赋值</span></span><br><span class="line">  <span class="keyword">return</span> sub_412A90();                          <span class="comment">// 得到flag</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//sub_412A90() line 36</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//int sub_412D60() line 9</span></span><br><span class="line"> <span class="type">int</span> <span class="title function_">Key_func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)StartAddress, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  hHandle = (HANDLE)sub_41127B();</span><br><span class="line">  CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)sub_411316, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">//sub_411316 line3</span></span><br><span class="line"><span class="comment">//定位到关键函数</span></span><br><span class="line">__int64 __stdcall <span class="title function_">sub_411B80</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line">  __int64 v2; <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+0h] [ebp-13Ch]</span></span><br><span class="line">  <span class="type">size_t</span> Size; <span class="comment">// [esp+D0h] [ebp-6Ch]</span></span><br><span class="line">  <span class="type">char</span> Buf2; <span class="comment">// [esp+DCh] [ebp-60h]</span></span><br><span class="line">  <span class="type">int</span> v7_32; <span class="comment">// [esp+108h] [ebp-34h]</span></span><br><span class="line">  <span class="type">char</span> flag; <span class="comment">// [esp+114h] [ebp-28h]</span></span><br><span class="line">  <span class="type">int</span> savedregs; <span class="comment">// [esp+13Ch] [ebp+0h]</span></span><br><span class="line"></span><br><span class="line">  sub_41137F((<span class="type">int</span>)&amp;unk_41D0F4);</span><br><span class="line">  WaitForSingleObject(hObject, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">  Check_Run_Error(&amp;v4 == &amp;v4);</span><br><span class="line">  Print_str((<span class="type">int</span>)<span class="string">&quot;please input your flag:&quot;</span>, v4);</span><br><span class="line">  Input_str(<span class="string">&quot;%32s&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)&amp;flag);</span><br><span class="line">  v7_32 = j_strlen(&amp;flag);</span><br><span class="line">  Enc_str(<span class="number">16</span>, (<span class="type">int</span>)&amp;flag, v7_32, (<span class="type">int</span>)&amp;Buf2);</span><br><span class="line">  Size = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !j_memcmp(&amp;unk_41B018, &amp;Buf2, <span class="number">32u</span>) )</span><br><span class="line">    Print_str((<span class="type">int</span>)<span class="string">&quot;you win!&quot;</span>, v4);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    Print_str((<span class="type">int</span>)<span class="string">&quot;you lose!&quot;</span>, v4);</span><br><span class="line">  SetEvent(hObject);</span><br><span class="line">  Check_Run_Error(&amp;v4 == &amp;v4);</span><br><span class="line">  HIDWORD(v2) = v1;</span><br><span class="line">  LODWORD(v2) = <span class="number">1</span>;</span><br><span class="line">  sub_411217((<span class="type">int</span>)&amp;savedregs, (<span class="type">int</span>)&amp;dword_411C7C);</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​    猜测memcmp比较的：unk_41B018是程序的密文，Buf2存储根据输入生成的密文。</p>
<p>跟入前面的处理函数，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __cdecl <span class="title function_">sub_411DA0</span><span class="params">(<span class="type">int</span> a1_16, <span class="type">int</span> flag, <span class="type">int</span> a3_32, <span class="type">int</span> cipher)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// eax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// STEB_1</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v7; <span class="comment">// STDF_1</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// ST04_8</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">264</span>]; <span class="comment">// [esp+E8h] [ebp-16Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+1F0h] [ebp-64h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+1F4h] [ebp-60h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+1F8h] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+1FCh] [ebp-58h]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp+200h] [ebp-54h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+20Ch] [ebp-48h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+218h] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+224h] [ebp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v19; <span class="comment">// [esp+230h] [ebp-24h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [esp+23Ch] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> v21; <span class="comment">// [esp+23Dh] [ebp-17h]</span></span><br><span class="line">  <span class="type">char</span> v22; <span class="comment">// [esp+23Eh] [ebp-16h]</span></span><br><span class="line">  <span class="type">char</span> v23[<span class="number">21</span>]; <span class="comment">// [esp+23Fh] [ebp-15h]</span></span><br><span class="line">  <span class="type">int</span> savedregs; <span class="comment">// [esp+254h] [ebp+0h]</span></span><br><span class="line"></span><br><span class="line">  sub_41137F((<span class="type">int</span>)&amp;unk_41D0F4);</span><br><span class="line">  v11 = <span class="number">1</span>;</span><br><span class="line">  v12 = <span class="number">0x55</span>;</span><br><span class="line">  v13 = <span class="number">0x1C39</span>;</span><br><span class="line">  v14 = <span class="number">0x95EED</span>;</span><br><span class="line">  v15 = <span class="number">0x31C84B1</span>;</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i += <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = j_strlen(Dest);</span><br><span class="line">    <span class="keyword">if</span> ( v19 &gt;= v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v16 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">5</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( Dest[j + v19] == <span class="number">0x7A</span> )</span><br><span class="line">        *(&amp;v20 + j + i) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v16 += *(&amp;v11 + <span class="number">4</span> - j) * (Dest[j + v19] - <span class="number">33</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v23[i] = v16;</span><br><span class="line">    *(&amp;v22 + i) = BYTE1(v16);</span><br><span class="line">    *(&amp;v21 + i) = BYTE2(v16);</span><br><span class="line">    *(&amp;v20 + i) = HIBYTE(v16);</span><br><span class="line">    v19 += <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = sub_411127((<span class="type">int</span>)&amp;v20, a1_16, (<span class="type">int</span>)v10);</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; a3_32; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 = (<span class="type">signed</span> <span class="type">int</span>)(v19 + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">    i = (i + (<span class="type">unsigned</span> __int8)v10[v19]) % <span class="number">256</span>;</span><br><span class="line">    v6 = v10[v19];</span><br><span class="line">    v10[v19] = v10[i];</span><br><span class="line">    v10[i] = v6;</span><br><span class="line">    v7 = v10[((<span class="type">unsigned</span> __int8)v10[i] + (<span class="type">unsigned</span> __int8)v10[v19]) % <span class="number">256</span>];</span><br><span class="line">    HIDWORD(v5) = v7;</span><br><span class="line">    *(_BYTE *)(j + cipher) = v7 ^ *(_BYTE *)(j + flag);<span class="comment">// cipher[j]=v7^flag[j]</span></span><br><span class="line">  &#125;</span><br><span class="line">  v8 = __PAIR__(HIDWORD(v5), j);</span><br><span class="line">  Check_Stack((<span class="type">int</span>)&amp;savedregs, (<span class="type">int</span>)&amp;dword_411FF8);</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到前面根据一系列操作，生成了v7，然后用v7和flag异或得到了正确的cipher。</p>
<h2 id="所以动态调试，"><a href="#所以动态调试，" class="headerlink" title="所以动态调试，"></a>所以动态调试，</h2><p>1.先搜索字符串，下好断点，一个是输入位置，一个是比较位置。</p>
<p><img src="/categories/CTF/rev02/1691327074344.png" alt="1691327074344"></p>
<h3 id="考点1"><a href="#考点1" class="headerlink" title="考点1"></a>考点1</h3><p>多线程下好断点。</p>
<p><img src="/categories/CTF/rev02/1691326897356.png" alt="1691326897356"></p>
<h3 id="考点2"><a href="#考点2" class="headerlink" title="考点2"></a>考点2</h3><p>2.一开始直接<code>jmp F12E10</code>。</p>
<p><img src="/categories/CTF/rev02/1691325095601.png" alt="1691325095601"></p>
<p>3.进入到F12A90。</p>
<p>F9运行，断到了线程函数执行前。</p>
<p><img src="/categories/CTF/rev02/1691327641950.png" alt="1691327641950"></p>
<p>按几下F9，成功断到了关键函数处。</p>
<p><img src="/categories/CTF/rev02/1691328283702.png" alt="1691328283702"></p>
<p>此时的线程状态：</p>
<p><img src="/categories/CTF/rev02/1691328244877.png" alt="1691328244877"></p>
<h3 id="考点3"><a href="#考点3" class="headerlink" title="考点3"></a>考点3</h3><p>跟入F11037，在F12860的跳转处，强制让其不跳转。</p>
<p><img src="/categories/CTF/rev02/1691329006039.png" alt="1691329006039"></p>
<p>断在输入位置0x411BDE位置，</p>
<p><img src="/categories/CTF/rev02/1691329286256.png" alt="1691329286256"></p>
<p>先随便输入32个1，根据对比函数里的栈地址，找到密文unk_41B018，</p>
<p><img src="/categories/CTF/rev02/1691329776133.png" alt="1691329776133"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00F1B018  DE 1C 22 27 1D AE AD 65 AD EF 6E 41 4C 34 75 F1  ?&quot;&#x27;enAL4u?</span><br><span class="line">00F1B028  16 50 50 D4 48 69 6D 93 36 1C 86 3B BB D0 4C 91  PP訦im??恍L?</span><br></pre></td></tr></table></figure>
<p>整理如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DE1C22271DAEAD65ADEF6E414C3475F1165050D448696D93361C863BBBD04C91</span><br></pre></td></tr></table></figure>
<p>再次运行程序，先断到长度函数处。</p>
<p><img src="/categories/CTF/rev02/1691330092818.png" alt="1691330092818"></p>
<p>修改这里的输入值，将前面的密文输入进去。</p>
<p><img src="/categories/CTF/rev02/1691330196880.png" alt="1691330196880"></p>
<p>再断到加密函数位置处：</p>
<p><img src="/categories/CTF/rev02/1691330953276.png" alt="1691330953276"></p>
<p>经过异或处理后，此时memcmp的Buf2里, 就是flag值。</p>
<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><p><img src="/categories/CTF/rev02/1691330848182.png" alt="1691330848182"></p>
<p><img src="/categories/CTF/rev02/1691330936363.png" alt="1691330936363"></p>
<h3 id="Run跟踪"><a href="#Run跟踪" class="headerlink" title="Run跟踪"></a>Run跟踪</h3><ul>
<li>跟踪一个call运行了哪些代码，有递归所有call和只对一层call的方法，操作方式分别是CTRL+F11和CTRL+F12。 </li>
</ul>
<h3 id="给线程下断的另一种方式"><a href="#给线程下断的另一种方式" class="headerlink" title="给线程下断的另一种方式"></a>给线程下断的另一种方式</h3><p><img src="/categories/CTF/rev02/1691331179709.png" alt="1691331179709"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/Notes/Linkers&Loaders03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/Notes/Linkers&Loaders03/" class="post-title-link" itemprop="url">Chap6-可执行文件的装载和进程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-08-03 14:58:58" itemprop="dateCreated datePublished" datetime="2023-08-03T14:58:58+08:00">2023-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-18 21:58:38" itemprop="dateModified" datetime="2023-08-18T21:58:38+08:00">2023-08-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>假设程序都是静态链接的，先从整体上把握程序的装载过程，下一章将把程序拆成模块来观察。</p>
</blockquote>
<p>Linux下的分段故障<code>Segmentation fault</code>与Windows的“进程因非法操作需要关闭，很多时候是因为进程访问了未经允许的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**Linux操作系统</span></span><br><span class="line"><span class="comment"> * |----------------------------------|</span></span><br><span class="line"><span class="comment"> * |              操作系统空间         | 1G</span></span><br><span class="line"><span class="comment"> * |----------------------------------| 0xC0000000</span></span><br><span class="line"><span class="comment"> * |                                  |</span></span><br><span class="line"><span class="comment"> * |                                  | </span></span><br><span class="line"><span class="comment"> * |             用户进程空间          |   3G</span></span><br><span class="line"><span class="comment"> * |                                  |</span></span><br><span class="line"><span class="comment"> * |                                  |</span></span><br><span class="line"><span class="comment"> * |__________________________________| 0x00000000</span></span><br><span class="line"><span class="comment"> * WinXP默认操作系统占据2G内存，可以调整使其只占1G内存。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h3><p>(Physical Address Extension)，是针对32位CPU内存不足的一种修补。类似的，针对16位CPU，借助段偏移寻址能够达到1MB，每次读块只能读64KB，使用XMS(一种中断处理技术)读取大于1MB内存的地方。</p>
<p>OS采用36位地址线\内存地址时，程序使用的最大虚拟地址空间仍旧不会超过4GB，但是它程序的虚拟地址空间可以映射到的物理内存的范围扩大到64GB。</p>
<p>通过这种页或块映射在Win下访存的操作方式叫地址窗口映射扩展AWE(Address Windowing Extension)；在Linu下通过mmap()系统调用来实现。</p>
<h3 id="装载的方式"><a href="#装载的方式" class="headerlink" title="装载的方式"></a>装载的方式</h3><ul>
<li>overlay覆盖装入，适合内存受限场景比如木马或者嵌入式设备；</li>
</ul>
<p>保证调用路径上的块都在内存；禁止跨树间调用。</p>
<p>编写程序时将程序分块，写一小段辅助代码，管理模块在内存的驻留和更替。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * |----------------------------------------------------|</span></span><br><span class="line"><span class="comment"> * |----------------------------------------------------|</span></span><br><span class="line"><span class="comment"> * |                 Overlay Manager (几十Bytes)        |</span></span><br><span class="line"><span class="comment"> * |----------------------------------------------------|</span></span><br><span class="line"><span class="comment"> * |                  Main (1024 bytes)                 | </span></span><br><span class="line"><span class="comment"> * |											    |</span></span><br><span class="line"><span class="comment"> * |----------------------------------------------------|</span></span><br><span class="line"><span class="comment"> * |      A 模块 (512 bytes)    |   B 模块 (256 bytes)   |</span></span><br><span class="line"><span class="comment"> * |						 |----------------------- |</span></span><br><span class="line"><span class="comment"> * |----------------------------------------------------|</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>如上图所示，A和B模块互不依赖，都被Main模块调用时，则可以采用Overlay的方式，使得需要的内存空间节省256Bytes。</p>
<ul>
<li>Paging页映射 和页替换算法  MMU的地址映射</li>
</ul>
<h2 id="从操作系统可执行文件的装载"><a href="#从操作系统可执行文件的装载" class="headerlink" title="从操作系统可执行文件的装载"></a>从操作系统可执行文件的装载</h2><h3 id="进程的建立"><a href="#进程的建立" class="headerlink" title="进程的建立"></a>进程的建立</h3><ul>
<li>1.创建虚拟地址空间（只创建映射函数需要的数据结构，并不实际创建空间）<ul>
<li>Linux i386中是分配一个页目录，不设置页映射关系，在后面程序发生页错误的时候才设置）</li>
</ul>
</li>
<li>2.读取可执行文件头，建立虚拟空间与可执行文件的映射关系。（装载）</li>
</ul>
<p>(Linux中)</p>
<ul>
<li><p>3.令EIP=EOP of Executable File</p>
<p>​    内核堆栈和用户堆栈的切换、CPU运行权限切换</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">页面可执行文件的偏移&lt;----（装载）----&gt;虚拟存储空间&lt;-----------&gt;物理内存</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>Linux将进程虚拟空间中的一个段叫VMA(Virtual Mempry Area)，包括</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start address;size;Attributes(RWE);State;Type;</span><br></pre></td></tr></table></figure>
<p>对于相同权限状态的节Section，把它们<strong>合并到一起</strong>作为一个段Segment映射。这样在进程虚拟空间中只有一个VMA而不是多个，可以减少页面内部碎片，节省内存空间。</p>
<h3 id="页错误"><a href="#页错误" class="headerlink" title="页错误"></a>页错误</h3><p>程序执行时进程虚拟空间中发生Page Fault，控制权从进程转移到OS；</p>
<p>根据数据结构找到VMA，计算页面在磁盘文件中的偏移，</p>
<p>然后物理内存分配物理页，读取该磁盘块到物理页中，</p>
<p>将发生页错误的虚拟页与物理页之间建立映射关系。</p>
<p>控制权归还给进程，从发生页错误的位置继续执行。</p>
<h2 id="ELF文件"><a href="#ELF文件" class="headerlink" title="ELF文件"></a>ELF文件</h2><p>从链接角度(Linking View)看，elf文件按照节section存储，描述它的结构叫做节表Section Headers；</p>
<p>从装载角度或者执行视图(Execution View)看，elf文件可以按照段segment划分，描述它的结构叫做程序头Program Header；</p>
<p>elf可执行文件和共享库文件处于装载的需要，比目标文件多一个程序头表(Program Header Table)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 程序头表</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word p_type;      <span class="comment">// 段的类型，如LOAD:1.DYNAMIC,INTERP</span></span><br><span class="line">    Elf32_Addr p_offset;    <span class="comment">// 段在文件中的偏移量</span></span><br><span class="line">    Elf32_Addr p_vaddr;     <span class="comment">// 段在内存中的虚拟地址</span></span><br><span class="line">    Elf32_Addr p_paddr;     <span class="comment">// 段在物理内存中的地址（对于嵌入式系统可能有用）</span></span><br><span class="line">    Elf32_Word p_filesz;    <span class="comment">// 段在文件中的大小，可能是0</span></span><br><span class="line">    Elf32_Word p_memsz;     <span class="comment">// 段在进程虚拟地址空间中占用的大小，可能是0</span></span><br><span class="line">    Elf32_Word p_flags;     <span class="comment">// 段的属性标志，如可读、可写、可执行等</span></span><br><span class="line">    Elf32_Word p_align;     <span class="comment">// 字节按照2^p_align次方对齐</span></span><br><span class="line">&#125; Elf32_Phdr;</span><br></pre></td></tr></table></figure>
<p>对于LOAD类型的Segment，p_memsz一定&gt;=p_filesz（bss被合并在数据类型的段里，存放那些未被初始化的数据）。</p>
<h2 id="PE文件的装载"><a href="#PE文件的装载" class="headerlink" title="PE文件的装载"></a>PE文件的装载</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>PE文件可以装载到任何内存位置。PE文件中选用RVA，因为RVA可以始终保持一致。</p>
<p>1.读取文件第一个页，获取到DOS头、PE头、段表。</p>
<p>2.选择装载地址。检查进程空间地址里，目标地址是否可用。若不可用，则另外选择装载地址。</p>
<p>3.段映射。使用段表将PE文件中的段，映射到进程内存空间地址。—&gt;若装载地址≠目标地址，Rebasing。</p>
<p>4.装载所需要的dll文件—&gt;解析PE文件中的导入符号——&gt;</p>
<p>5.建立初始化栈和堆—&gt;建立主线程并启动进程</p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">coffHeader&#123;</span><br><span class="line">    optionalHeader&#123;</span><br><span class="line">        ...</span><br><span class="line">        u32 addressofEntryPoint;<span class="comment">//装载后PE文件第一个指令的RVA,病毒感染PE文件后要修改入口点，篡改执行流程。</span></span><br><span class="line">        u32 SectionAlignment;<span class="comment">//内存中段对齐粒度，默认是4K=4096字节</span></span><br><span class="line">        u32 FileAlignMent;<span class="comment">//文件中段对齐粒度，默认是512字节</span></span><br><span class="line">        u32 baseofCode;</span><br><span class="line">        u32 baseofData;<span class="comment">//数据段起始RVA</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-4-进程虚存空间分布"><a href="#6-4-进程虚存空间分布" class="headerlink" title="6.4 进程虚存空间分布"></a>6.4 进程虚存空间分布</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/Notes/Pediy02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/Notes/Pediy02/" class="post-title-link" itemprop="url">CPU体系架构回顾</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-02 14:19:49 / Modified: 17:50:28" itemprop="dateCreated datePublished" datetime="2023-08-02T14:19:49+08:00">2023-08-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><a target="_blank" rel="noopener" href="https://www.kanxue.com/chm.htm?id=13855&amp;pid=node1000002">https://www.kanxue.com/chm.htm?id=13855&amp;pid=node1000002</a></p>
</blockquote>
<h2 id="指令集"><a href="#指令集" class="headerlink" title="指令集"></a>指令集</h2><ul>
<li><p>MIPS  长度固定的指令，是RISC，处理器通过硬连线实现 </p>
</li>
<li><p>x86(IA-32)，长度变化，用CISC的指令集，CISC的处理器需要用微指令配合运行。但是当下Intel实际处理器的结构都已经变成了risc结构了，risc的结构实现流水线等特性比较容易。 </p>
</li>
</ul>
<p> cisc的寄存器数量较少，指令能够实现一些比较特殊的功能，例如Win32汇编语言对应的8086的一些寄存器： AX-DX，CS、DS、ES、SS。</p>
<p>GNU编译的elf文件对应到RISC的寄存器，会有很多通用寄存器。</p>
<p> 虚拟模式需要使用一些特殊的寄存器、为了支持分页需要使用页表寄存器等，为了加速内存的访问需要使用TLB，加速数据和指令的访问而使用data cache和instruction cache等 </p>
<blockquote>
<p>jmp $是为了让程序停在这一行，防止程序跑飞（跑飞的程序危害很大！有可能把数据当代码或者把代码当数据！）</p>
</blockquote>
<h3 id="仿真工具"><a href="#仿真工具" class="headerlink" title="仿真工具"></a>仿真工具</h3><p> 用synplify综合的电路，然后用debussy+modelsim仿真 </p>
<h2 id="IA-32的指令格式"><a href="#IA-32的指令格式" class="headerlink" title="IA-32的指令格式"></a>IA-32的指令格式</h2><p><img src="/categories/Notes/Pediy02/1690965899478.png" alt="1690965899478"></p>
<p>前缀部分可选，分为四个group。</p>
<p> 操作数前缀用于设置 锁总线和重复前缀 、段重写和分支预测、操作数宽度、地址宽度。</p>
<h3 id="Opcode"><a href="#Opcode" class="headerlink" title="Opcode"></a>Opcode</h3><ol>
<li><p>x86的opcode最短是1个字节，最长是3个字节。 </p>
</li>
<li><p>x86对于源操作数和目的操作数是暗含在opcode里面的。 </p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">88 11 BL(011) CL(001)     88 D9 MOV CL, BL               MR   </span><br><span class="line">8A 11 011 001             8A D9 MOV BL(011),CL(001)      R&lt;--M</span><br></pre></td></tr></table></figure>
<ol>
<li><p>二字节通用opcode是0fh+一字节的编码；但是二字节的SIMD opcode是三字节长度，即一个强制前缀+0fh+一字节的操作码。 </p>
</li>
<li><p>同样的，三字节的通用opcode，是0fh+二字节的编码。SIMD opcode格式是强制前缀+0FH+二字节编码。 </p>
<p>5.个别的SIMD指令不需要强制前缀来引导，比如addps(0FH+58H) </p>
</li>
</ol>
<blockquote>
<p> <code>addps</code>指令中，<code>ps</code>代表”packed single-precision floating-point” 。</p>
<p>XMM （eXtended MultiMedia ） 寄存器是SSE（Streaming SIMD Extensions）指令集中的一种寄存器。</p>
<p>它可以同时存储4个单精度浮点数，每个数占用32位，总共128位。</p>
<p>对应的，MM寄存器是64位的。</p>
<p><code>addps</code>指令将分别对应位置上的单精度浮点数相加，并将结果存储回目标XMM寄存器中。 </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0F 58 01  addps xmm0,xmmword ptr[ecx] //从内存位置ecx处取128位单精度浮点数值加到xmm0 寄存器中的128位单精度浮点数上</span><br></pre></td></tr></table></figure>
<h3 id="Mod-R-M"><a href="#Mod-R-M" class="headerlink" title="Mod R/M"></a>Mod R/M</h3><p>切分为3个位域，233.</p>
<p> mod:提供寻址模式，11=寄存器寻址 其余都是内存寻址<br> reg/opcode：<br>  两种作用，第一种是提供寄存器寻址；另一种为某些opcode提供补充说明。<br> R/M：<br>  结合MOD位域，提供内存/寄存器寻址。 </p>
<p> R/M=100&amp; MOD≠11 作为SIB的转义码 。</p>
<p>例如，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">编码mov eax(000)，ebx(011)</span><br><span class="line">89H       11        011    000  89 D8                MR</span><br><span class="line">8BH       11        000    011  8B C3                RM</span><br><span class="line">//x86把源和目的操作数隐藏在opcode里面</span><br></pre></td></tr></table></figure>
<p><img src="/categories/Notes/Pediy02/1690969519285.png" alt="1690969519285"></p>
<h3 id="SIB"><a href="#SIB" class="headerlink" title="SIB"></a>SIB</h3><p> 同modr/m类似，SIB字节也是采用233切分成三个位域，名字分别叫Scale、Index、Base。SIB的名字也来自这三个位域名字的首字母缩写。<br> SIB字节由 R/M=100&amp; MOD≠11 引导出来。<br>1.SIB确定的寻址方式是[base+Index* Scale +disp]， </p>
<blockquote>
<p>esp作为index时候，index自动被忽略,即此时scale因子视为0 ， 寻址计算方法是[base+disp] </p>
</blockquote>
<p>2.disp意思是后面尾随的若干个displacement字节。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mov eax，[0x1]可以编码为以下形式：</span><br><span class="line">a）采用moffs32编码</span><br><span class="line">   opcode moffs32</span><br><span class="line">   A1    01 00 00 00</span><br><span class="line">   A1    40H</span><br><span class="line">b）采用MODR/M引导的disp</span><br><span class="line">  opcode   mod   reg   r/m  displacement</span><br><span class="line">  8B       00    000   101  01 00 00 00H</span><br><span class="line">  8B       05H              01 00 00 00H</span><br><span class="line">c）采用SIB引导的disp</span><br><span class="line">  opcode   mod   reg   r/m  scale    index  base   displacement</span><br><span class="line">  8B       00    000   100    01     100    101  01 00 00 00H</span><br><span class="line">  8B       04H                65H                01 00 00 00H</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/ML/APT02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/ML/APT02/" class="post-title-link" itemprop="url">一些论文问题的总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-31 17:13:22 / Modified: 17:18:50" itemprop="dateCreated datePublished" datetime="2023-07-31T17:13:22+08:00">2023-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ML/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-数据不平衡问题"><a href="#1-数据不平衡问题" class="headerlink" title="1.数据不平衡问题"></a>1.数据不平衡问题</h2><h2 id="2-数据饥饿问题"><a href="#2-数据饥饿问题" class="headerlink" title="2.数据饥饿问题"></a>2.数据饥饿问题</h2><h2 id="3-静态检测时混淆加密手段的干扰"><a href="#3-静态检测时混淆加密手段的干扰" class="headerlink" title="3.静态检测时混淆加密手段的干扰"></a>3.静态检测时混淆加密手段的干扰</h2><h2 id="4-运行崩溃的解决"><a href="#4-运行崩溃的解决" class="headerlink" title="4.运行崩溃的解决"></a>4.运行崩溃的解决</h2><h2 id="5-样本中特征不足导致矩阵全0"><a href="#5-样本中特征不足导致矩阵全0" class="headerlink" title="5.样本中特征不足导致矩阵全0"></a>5.样本中特征不足导致矩阵全0</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/ML/APT01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/ML/APT01/" class="post-title-link" itemprop="url">面向 APT 家族分析的攻击路径预测方法研究</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-31 16:13:22 / Modified: 17:51:50" itemprop="dateCreated datePublished" datetime="2023-07-31T16:13:22+08:00">2023-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ML/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>面向 APT 家族分析的攻击路径预测方法研究，信息学报，陈伟翔 1, 任怡彤 1, 肖岩军 2, 侯 锐 3, 田志宏 1 </p>
</blockquote>
<p>IDS需要关联 APT 生命周期内的数 个阶段, 以此提高检测攻击能力。</p>
<h2 id="1-要解决的问题"><a href="#1-要解决的问题" class="headerlink" title="1.要解决的问题"></a>1.要解决的问题</h2><p>基因库—可靠数据获取方法</p>
<p>HMM——预测的攻击路径的可解释性</p>
<h2 id="2-概念"><a href="#2-概念" class="headerlink" title="2.概念"></a>2.概念</h2><h3 id="攻击行为概述"><a href="#攻击行为概述" class="headerlink" title="攻击行为概述"></a>攻击行为概述</h3><p>“寻找入口点”、“C2 通信”、“权限提升”、“资 产发现”、“数据过滤”、</p>
<h3 id="APT-攻击路径的可见状态集"><a href="#APT-攻击路径的可见状态集" class="headerlink" title="APT 攻击路径的可见状态集"></a>APT 攻击路径的可见状态集</h3><h4 id="注册表-amp-服务"><a href="#注册表-amp-服务" class="headerlink" title="注册表&amp;服务"></a>注册表&amp;服务</h4><p>CS(create-service): 创建服务</p>
<p>MRV(modify-registry-value): 修 改注册表的行为; </p>
<p>DRKV(delete-registry-key-value): 删除注册表关键信息的行为; </p>
<h4 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h4><p>CKO(create-kernelobject): 创建内核对象的行为;  </p>
<p>MMP(modify-memory-property): 修 改内存权限的行为; </p>
<h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><p>CP(create-process): 创建进程;</p>
<p>LL(load-library): 加载 库 ;</p>
<p>ESI(execshellcode-instr): 执行 shellcode 指令; </p>
<p>EHI(exec-heapinstr): 执行堆指令;</p>
<p>WTPM(write-to-process-memory): 写入进程内存;</p>
<p> ERI(exec-ret-instr): 执行 ret 指令;</p>
<p> EEI(exec-esp-instr): 执行 esp 指令;</p>
<p> CT(create-thread): 创建线程; </p>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p>SDQ(send-dnsquery): 发送 DNS 请求行为;</p>
<p>SNP(send-network-packet): 发送网络数据包;</p>
<p>LOP(listen-on-port): 监听端口。</p>
<p>CTS(connect-to-socket): 连接 socket;</p>
<h4 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h4><p>CF(create-process): 创 建文件的行为;</p>
<p> WTF(write-to-file): 写入文件的行为;</p>
<h3 id="动态分析工具"><a href="#动态分析工具" class="headerlink" title="动态分析工具"></a>动态分析工具</h3><p>Anubis、Norman、Joebox</p>
<h3 id="基因库"><a href="#基因库" class="headerlink" title="基因库"></a>基因库</h3><p>基因(序列)：(MD5,env,object_1,object_2,action_name)按照时间排序</p>
<p>object_1 与 object_2 分别代表软件执行动作的对象 和路径</p>
<p>同一个 APT 家族下恶意软件基因集合, 称为一个 APT 家族的基 因库。</p>
<h3 id="钻石模型"><a href="#钻石模型" class="headerlink" title="钻石模型"></a>钻石模型</h3><p>一个 APT 攻击包含“攻击者”、 “受害者”、 “能力”和“基础设施”4 个核心元 素。</p>
<p>“能力”是攻击者使用的工具或技术, 从 探查到最终目的达成, “技术”存在于每一个攻击阶 段, 每一个恶意动作对应的技术细节可体现出相应 战略意图。</p>
<p>“基础设施”是攻击者维持权限控制的通 道或者载体。</p>
<h2 id="3-方法"><a href="#3-方法" class="headerlink" title="3.方法"></a>3.方法</h2><h2 id="Smith-waterman算法"><a href="#Smith-waterman算法" class="headerlink" title="Smith waterman算法+"></a>Smith waterman算法+</h2><p>相似的公共子序列一定是得分最高的那一条。</p>
<p> <strong>比对序列为：A=GGTTGACTA，B=TGTTACGG</strong> </p>
<p>则两序列的长度分别为len(A) = n，Len(B)=m；<br>s(a,b)：字符a和字符b的相似分数，这里设置为3，不相等则为-3；</p>
<p>W1 = 2 ：一个空位罚分，这里设置为2（可根据需要设置） </p>
<p>H：匹配分数矩阵如下。</p>
<p><img src="/categories/ML/APT01/1690796434417.png" alt="1690796434417"></p>
<ol>
<li>初始化算法分数矩阵H。A是列向量，B是行向量。使行i表示字符ai，列j表示字符bj；</li>
<li></li>
</ol>
<p><img src="/categories/ML/APT01/1690796255740.png" alt="1690796255740"></p>
<ol>
<li>回溯，从矩阵H中分数最大的一项开始：<br>若ai=bj，则回溯到左上角单元格<br>若ai≠bj，回溯到左上角、上边、左边中值最大的单元格，若有相同最大值的单元格，优先级按照左上角、上边、左边的顺序</li>
<li>根据回溯路径，写出匹配字符串：<br>若回溯到左上角单元格，将ai添加到匹配字串A‘，将bj添加到匹配字串B’；<br>若回溯往上走，此时A走了，B没走。将ai添加到匹配字串A’，将_添加到匹配字串B’；<br>若回溯到左边单元格，B走了，A没走。将_添加到匹配字串A’，将bj添加到匹配字串B’。</li>
<li>得到局部最优匹配序列，结束</li>
</ol>
<h3 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h3><p>1.<strong>APT基因库</strong>要去重、去无效、去冗余（Smith-waterman局部序列对比算法去除相似基因，阈值为80%）。</p>
<p>-&gt;节省存储、简化算法复杂度</p>
<p>基因个体不重要，基因行为才重要。：(MD5,env,object_1,object_2,action_name)，去除md5，env作关键词替换，object1只保留可执行文件。</p>
<p>2.<strong>公共基因：</strong>对所有APT基因库中的基因进行相似度检测，相似度90%以上的基因序列作为公共基因。</p>
<p>恶意软件的通用动作。</p>
<p>3.<strong>恶意行为基因库</strong>：各个家族APT基因库-公共基因，之后合并各个家族基因库。</p>
<p>4.可观测状态集：<strong>恶意软件行为可观测链：</strong>恶意软件基因序列,与恶意行为基因库进行比较。保留相似度 Thres_hold 在 90%以上的基因序列的基因尾的动作名称，不包含基因段属性信息，从而保证可观测状态可计算属性。</p>
<h4 id="缺陷1："><a href="#缺陷1：" class="headerlink" title="缺陷1："></a>缺陷1：</h4><p>恶意行为基因库进 行可观测链提取, 而这些基因序列来自于软件行为。</p>
<p>只能使用基因中 包含 C2 通信的部分进行关联和提取, 基因库的使用 率不足 30%,</p>
<p>5.隐藏状态集 资产发现 数据过滤 寻找入口 C2 通信</p>
<p>将测试集 中的样本放入各自的 APT 家族的 HMM 中计算下一 时刻攻击路径的隐藏状态和可观测状态的概率</p>
<h3 id="展示结果时"><a href="#展示结果时" class="headerlink" title="展示结果时"></a>展示结果时</h3><p>将各个家族样本按照编号排序，把得分取对数，构成下面的得分图。</p>
<p><img src="/categories/ML/APT01/1690793540423.png" alt="1690793540423"></p>
<h2 id="4-优势"><a href="#4-优势" class="headerlink" title="4.优势"></a>4.优势</h2><h3 id="1-精准定位到具体基因"><a href="#1-精准定位到具体基因" class="headerlink" title="1.精准定位到具体基因"></a>1.精准定位到具体基因</h3><hr>
<p>能精准定位到具体基因, 能在一定程度上应对 恶意软件变种, 能在一定程度上应对 恶意软件变种</p>
<h3 id="2-可同时对隐藏状态和可观测状态展开预测"><a href="#2-可同时对隐藏状态和可观测状态展开预测" class="headerlink" title="2.可同时对隐藏状态和可观测状态展开预测"></a>2.可同时对隐藏状态和可观测状态展开预测</h3><h3 id="3-在进行最终结果判定时-将多个观测值作为判定结果"><a href="#3-在进行最终结果判定时-将多个观测值作为判定结果" class="headerlink" title="3.在进行最终结果判定时, 将多个观测值作为判定结果"></a>3.在进行最终结果判定时, 将多个观测值作为判定结果</h3><p>只要结果在观测值组里，就正确，可以提高实验表现，也能提供参考。</p>
<h2 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h2><p>隐藏状态只有四个；</p>
<p>在 数据质量方面, 若一条观测链在多个模型下均展现 出极少或是单一的 APT 阶段, 就会严重影响 HMM 的构建。</p>
<p>在多个路径时，基因检测的识别准确率不如 HMM 检测法, 但是</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/ML/Few-Shot19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/ML/Few-Shot19/" class="post-title-link" itemprop="url">利用三阶段特征选择和数据不平衡纠正增强勒索软件分类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-07-31 16:13:22 / Modified: 17:16:34" itemprop="dateCreated datePublished" datetime="2023-07-31T16:13:22+08:00">2023-07-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ML/" itemprop="url" rel="index"><span itemprop="name">机器学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>勒索软件维度太多、数据不平衡，不容易建立模型。</p>
<ul>
<li>考虑样本不同特征组的重要程度，三阶段特征选择，解决样本维度问题；</li>
<li>代价敏感学习(Cost Sensitive Learning)和SMOTE重采样解决数据不平衡问题。</li>
</ul>
<h3 id><a href="#" class="headerlink" title=" "></a> </h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/Notes/IDAPro01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/Notes/IDAPro01/" class="post-title-link" itemprop="url">SP-Analysis failed[Xctf g0Re]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-29 14:58:58" itemprop="dateCreated datePublished" datetime="2023-07-29T14:58:58+08:00">2023-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-30 21:24:58" itemprop="dateModified" datetime="2023-07-30T21:24:58+08:00">2023-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>xctf的一道Go语言逆向题，涉及AES加密和base64换表加密。</p>
<p>用IDA打开g0Re报告<code>SP-Analysis failed</code>错误。</p>
<p><img src="/categories/Notes/IDAPro01/1690613919182.png" alt="1690613919182"></p>
<h2 id="静态检测"><a href="#静态检测" class="headerlink" title="静态检测"></a>静态检测</h2><p>将文件拷贝到kali后，静态检测一番。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ file g0Re               </span><br><span class="line">g0Re: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, no section header</span><br><span class="line"></span><br><span class="line">readelf -hlS --w g0Re</span><br></pre></td></tr></table></figure>
<p>报告如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">readelf: Warning: Section 49 has an out of range sh_link value of 2302008908</span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0] &lt;no-strings&gt;      00010102: &lt;unknown&gt; 00000001003e0002 481cb0 000040 400003      0   0 15762873573703680</span><br><span class="line">readelf: Warning: [ 1]: Link field (533963) should index a symtab section.</span><br><span class="line">readelf: Warning: [ 3]: Unexpected value (1482181455) in info field.</span><br></pre></td></tr></table></figure>
<p>strings找到一些特征字符串<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/idawork]</span><br><span class="line">└─$ strings -a  -tx g0Re|grep -E &#x27;\s&#123;4,30&#125;&#x27;</span><br><span class="line">     ec OKXX$</span><br><span class="line">    13e FN&#123;o</span><br><span class="line">    1e6 r mL</span><br><span class="line">    284 dRe6eYPgXygMd</span><br><span class="line">    295 fSCPpMP/C9DU36D2kliiYS5D9wKG/E_p</span><br><span class="line">    2b9 XkJb3WwcGMbUPd63r/bG8gVDS6EsZ5vv</span><br><span class="line">  81e18 $Info: This file is packed with the                                           </span><br><span class="line">  81e67 $Id:  </span><br></pre></td></tr></table></figure></p>
<p>猜测是UPX加壳，但是UPX标志被抹去了。</p>
<h2 id="UPX-标志被抹除"><a href="#UPX-标志被抹除" class="headerlink" title="UPX! 标志被抹除"></a>UPX! 标志被抹除</h2><p>unpack时会依次在三个地方检查UPX_MAGIC_LE32（即”UPX!”）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1、在倒数第36字节偏移处检查，如果特征值不符就会转入throwNotPacked()异常抛出函数，打印not packed by UPX；</span><br><span class="line">2、&quot;.ELF&quot;魔数前36字节处，如果这里的特征值不符就会转入throwCantUnpack()异常抛出函数，打印l_info corrupted；</span><br><span class="line">3、 在倒数第46字节偏移处检查，如果特征值不符就会转入throwCompressedDataViolation()异常抛出函数，打印Exception: compressed data violation；</span><br></pre></td></tr></table></figure>
<p><img src="/categories/Notes/IDAPro01/1690711701628.png" alt="1690711701628"></p>
<p>结合上面的规则2，可以很清晰地判断出出题人用<code>0KXX</code>代替了<code>UPX!</code>。</p>
<p><img src="/categories/Notes/IDAPro01/1690712364661.png" alt="1690712364661"></p>
<p>在对应的三个位置处换上UPX!魔数。</p>
<p><img src="/categories/Notes/IDAPro01/1690713002432.png" alt="1690713002432"></p>
<p><img src="/categories/Notes/IDAPro01/1690712555711.png" alt="1690712555711"></p>
<p>upx脱壳。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/idawork]</span><br><span class="line">└─$ upx -d g0Re_upx </span><br><span class="line">                       Ultimate Packer for eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2020</span><br><span class="line">UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020</span><br><span class="line"></span><br><span class="line">        File size         Ratio      Format      Name</span><br><span class="line">   --------------------   ------   -----------   -----------</span><br><span class="line">   1331200 &lt;-    534092   40.12%   linux/amd64   g0Re_upx</span><br><span class="line"></span><br><span class="line">Unpacked 1 file.</span><br></pre></td></tr></table></figure>
<h2 id="输入flag后的处理流程"><a href="#输入flag后的处理流程" class="headerlink" title="输入flag后的处理流程"></a>输入flag后的处理流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_int64 __usercall sub_48CD80@&lt;rax&gt;(__int64 i%16@&lt;rdi&gt;, __int64 key[i%16]@&lt;rsi&gt;, __int64 a3@&lt;r14&gt;, __int128 a4@&lt;xmm15&gt;)</span><br></pre></td></tr></table></figure>
<p>1.aes   2.base64    3.简单运算</p>
<p><img src="/categories/Notes/IDAPro01/1690723199822.png" alt="1690723199822"></p>
<p><img src="/categories/Notes/IDAPro01/1690723104727.png" alt="1690723104727"></p>
<h2 id="aes加密-密钥获取"><a href="#aes加密-密钥获取" class="headerlink" title="aes加密 密钥获取"></a>aes加密 密钥获取</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态调试获取密钥：wvgitbygwbk2b46d</span><br></pre></td></tr></table></figure>
<p>启动ida服务端。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#端口，密码，详细模式</span></span><br><span class="line"><span class="comment">#若希望同时维护几个调试实例，就要在不同端口启动调试服务器。</span></span><br><span class="line">./linux_server64 -p23946 -p23946 -v</span><br><span class="line">IDA Linux 64-bit remote debug server(ST) v1.22. Hex-Rays (c) 2004-2017</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/categories/Notes/IDAPro01/1690716983450.png" alt="1690716983450"></p>
<p>Hex窗口与RSI同步。</p>
<p><img src="/categories/Notes/IDAPro01/1690718805904.png" alt="1690718805904"></p>
<h2 id="base64换表加密"><a href="#base64换表加密" class="headerlink" title="base64换表加密"></a>base64换表加密</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strings -tx g0Re_upx|grep -E &#x27;[A-Z]&#123;10,64&#125;&#x27; </span><br><span class="line">12c040 456789&#125;#IJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123ABCDEFGH</span><br></pre></td></tr></table></figure>
<h2 id="解密脚本"><a href="#解密脚本" class="headerlink" title="解密脚本"></a>解密脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*-encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">string1 = <span class="string">&quot;456789&#125;#IJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123ABCDEFGH&quot;</span></span><br><span class="line">string2 = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"><span class="comment">#ascii字符范围</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_printable_chars</span>(<span class="params">flag</span>):</span><br><span class="line">    filtered_flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> flag:</span><br><span class="line">        <span class="keyword">if</span> byte <span class="keyword">in</span> string1:</span><br><span class="line">            filtered_flag+=byte</span><br><span class="line">        <span class="comment">#else:</span></span><br><span class="line">            <span class="comment">#print(&quot;ERROR&quot;)</span></span><br><span class="line">            <span class="comment">#break</span></span><br><span class="line">    <span class="keyword">return</span> filtered_flag</span><br><span class="line"></span><br><span class="line">enc=[    <span class="number">0xE6</span>, <span class="number">0xCE</span>, <span class="number">0x89</span>, <span class="number">0xC8</span>, <span class="number">0xCF</span>, <span class="number">0xC5</span>, <span class="number">0xF5</span>, <span class="number">0xC9</span>, <span class="number">0xD2</span>, <span class="number">0xD9</span>,   <span class="number">0xC0</span>, <span class="number">0x91</span>, <span class="number">0xCE</span>, <span class="number">0x7F</span>, <span class="number">0xAC</span>, <span class="number">0xCC</span>, <span class="number">0xE9</span>, <span class="number">0xCF</span>, <span class="number">0xB7</span>, <span class="number">0xC0</span>,   <span class="number">0x96</span>, <span class="number">0xD4</span>, <span class="number">0xEA</span>, <span class="number">0x92</span>, <span class="number">0xE2</span>, <span class="number">0xD7</span>, <span class="number">0xDF</span>, <span class="number">0x84</span>, <span class="number">0xCB</span>, <span class="number">0xA5</span>,   <span class="number">0xAE</span>, <span class="number">0x93</span>, <span class="number">0xA6</span>, <span class="number">0xCA</span>, <span class="number">0xBE</span>, <span class="number">0x97</span>, <span class="number">0xDF</span>, <span class="number">0xCE</span>, <span class="number">0xF0</span>, <span class="number">0xC9</span>,   <span class="number">0xB7</span>, <span class="number">0xE1</span>, <span class="number">0xAE</span>, <span class="number">0x6B</span>, <span class="number">0xC4</span>, <span class="number">0xB1</span>, <span class="number">0x65</span>, <span class="number">0xDB</span>, <span class="number">0xCE</span>, <span class="number">0xED</span>,   <span class="number">0x92</span>, <span class="number">0x93</span>, <span class="number">0xD6</span>, <span class="number">0x8C</span>, <span class="number">0xED</span>, <span class="number">0xC3</span>, <span class="number">0xA3</span>, <span class="number">0xDA</span>, <span class="number">0x94</span>, <span class="number">0xA5</span>,   <span class="number">0xAA</span>, <span class="number">0xB2</span>, <span class="number">0xB5</span>, <span class="number">0xA7</span>, <span class="number">0x55</span>]</span><br><span class="line">key=<span class="string">b&quot;wvgitbygwbk2b46d&quot;</span></span><br><span class="line">base = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):    </span><br><span class="line">    base+=<span class="built_in">chr</span>(((enc[i]-key[i%<span class="number">16</span>])^<span class="number">0x1a</span>) &amp;<span class="number">0xff</span>)</span><br><span class="line"><span class="built_in">print</span>(base)<span class="comment">#uB8EAyfxAmOEvQlrhCJM8hk1qonHskb55NM4qvmxZeY#xg5mMm10x0nF6b3iRdeYÄ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#过滤base64编码表里的字符</span></span><br><span class="line">str1=filter_printable_chars(base)</span><br><span class="line">result=base64.b64decode(str1.translate(<span class="built_in">str</span>.maketrans(string1,string2)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#AES解密</span></span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES<span class="comment"># </span></span><br><span class="line">aes = AES.new(key,mode=AES.MODE_ECB)</span><br><span class="line"><span class="built_in">print</span>(aes.decrypt(result)) <span class="comment">#b&#x27;flag&#123;g0_1s_th3_b3st_1anguage_1n_the_wOrld!_xxx&#125;\x01&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="反汇编算法"><a href="#反汇编算法" class="headerlink" title="反汇编算法"></a>反汇编算法</h2><ul>
<li>1.线性扫描反汇编 关键是确定代码起始位置，之后线性扫描整个代码段，并逐条反汇编每条指令。不会识别分支来解释控制流。<ul>
<li>优点：覆盖程序的所有代码段；</li>
<li>缺点：假设代码段中全是代码，没法处理代码段中混入的数据。</li>
</ul>
</li>
<li>2.递归下降反汇编。根据指令间的引用关系决定是否反汇编，在一个代码块内部，还是使用线性扫描算法。<ul>
<li>优点：大部分情况下可以区分代码和数据。</li>
<li>缺点：无法处理间接代码路径。</li>
</ul>
</li>
</ul>
<p>IDA pro是递归下降反汇编器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add、xor、mov、栈操作push</span></span><br><span class="line"><span class="keyword">case</span> 顺序流指令:</span><br><span class="line">	线性扫描反汇编</span><br><span class="line"><span class="comment">//jnz、ja</span></span><br><span class="line"><span class="keyword">case</span> 条件分支指令:</span><br><span class="line">	反汇编两个路径，直接反汇编下一条指令对应的分支，将跳转目标指令的地址加入延迟反汇编地址列表。</span><br><span class="line"><span class="comment">//jmp</span></span><br><span class="line"><span class="keyword">case</span> 无条件分支指令:</span><br><span class="line">	确定跳转目标，反汇编目的地址；对于无条件分支后的字节不作处理。</span><br><span class="line">，</span><br><span class="line"><span class="comment">//call</span></span><br><span class="line"><span class="keyword">case</span> 函数调用指令:</span><br><span class="line">	运行方式类似于无条件跳转，但是其后的返回地址会被直接反汇编，将跳转目标指令的地址加入延迟反汇编地址列表。</span><br><span class="line"><span class="comment">//ret,</span></span><br><span class="line"><span class="keyword">case</span> 返回指令:</span><br><span class="line">	获取接下来将要执行的指令信息；有时需要从栈顶获取，而静态反汇编器不具备访问栈的能力。此时反汇编器会开始处理延迟反汇编地址列表。</span><br></pre></td></tr></table></figure>
<h2 id="反汇编出问题的情形"><a href="#反汇编出问题的情形" class="headerlink" title="反汇编出问题的情形"></a>反汇编出问题的情形</h2><p>1.对于无条件分支指令，例如jmp eax这样的运行时才能确定跳转地址的指令，需要人工赋值。</p>
<p>2.call指令，在函数内部篡改了函数返回地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">foo proc near</span><br><span class="line">	inc  dword ptr[esp];</span><br><span class="line">	retn</span><br><span class="line">endp</span><br><span class="line">//错误的反汇编</span><br><span class="line">E8 F7 FF FF FF call foo</span><br><span class="line">05 89 45 F8 90 add eax,90F84589h</span><br><span class="line"></span><br><span class="line">//正确的反汇编</span><br><span class="line">E8 F7 FF FF FF call foo</span><br><span class="line">05 				db  5</span><br><span class="line">89 45 F8 		mov [ebp-8],eax</span><br><span class="line">90 				nop</span><br></pre></td></tr></table></figure>
<p>3.ret没有提供返回地址。</p>
<p><img src="/categories/Notes/IDAPro01/1690714484074.png" alt="1690714484074"></p>
<p> IDA遇到的函数返回语句，检测到其栈指针值不为0。</p>
<h2 id="反汇编的困难"><a href="#反汇编的困难" class="headerlink" title="反汇编的困难"></a>反汇编的困难</h2><p>1.编译，和自然语言的翻译一样是一个多对多操作。除了C编译器，还有Go、Python、Delphi编译器、WinAPI库，反编译器非常依赖语言和库。</p>
<p>2.编译过程中会丢失命名和类型信息。反汇编后最多知道变量的位数，类型信息需要通过变量的用途确定。</p>
<h2 id="一些静态工具用法"><a href="#一些静态工具用法" class="headerlink" title="一些静态工具用法"></a>一些静态工具用法</h2><ul>
<li><p>Linux:ldd；  nm展示符号，C++filter、展示重定义。</p>
</li>
<li><p>OSX:otool；  处理MACH-O。</p>
</li>
<li><p>Windows:VS里的dumpbin /dependents  ；objdump</p>
</li>
</ul>
<h3 id="ldd显示依赖库"><a href="#ldd显示依赖库" class="headerlink" title="ldd显示依赖库"></a>ldd显示依赖库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿kali)-[~/idawork]</span><br><span class="line">└─$ ldd linux_server64 </span><br><span class="line">        linux-vdso.so.1 (0x00007fff323bf000)</span><br><span class="line">        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fbfef767000)</span><br><span class="line">        libthread_db.so.1 =&gt; /lib/x86_64-linux-gnu/libthread_db.so.1 (0x00007fbfef75c000)</span><br><span class="line">        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007fbfef751000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fbfef730000)</span><br><span class="line">        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007fbfef515000)</span><br><span class="line">        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007fbfef3d2000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbfef1f6000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007fbfef782000)</span><br><span class="line">        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007fbfef1d6000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="dumpbin-dependents"><a href="#dumpbin-dependents" class="headerlink" title="dumpbin /dependents"></a>dumpbin /dependents</h3><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Dump of file baby.exe</span><br><span class="line"></span><br><span class="line">File <span class="built_in">Type</span>: EXECUTABLE IMAGE</span><br><span class="line"></span><br><span class="line">  Image has the following dependencies:</span><br><span class="line"></span><br><span class="line">    KERNEL32.dll</span><br><span class="line">    msvcrt.dll</span><br><span class="line">    msvcrt.dll</span><br><span class="line"></span><br><span class="line">  Summary</span><br><span class="line"></span><br><span class="line">        <span class="number">1000</span> .CRT  C runtime Lib</span><br><span class="line">        <span class="number">1000</span> .bss</span><br><span class="line">        <span class="number">1000</span> .data</span><br><span class="line">        <span class="number">1000</span> .debug_abbrev</span><br><span class="line">        <span class="number">1000</span> .debug_aranges</span><br><span class="line">        <span class="number">1000</span> .debug_frame</span><br><span class="line">        <span class="number">2000</span> .debug_info</span><br><span class="line">        <span class="number">1000</span> .debug_line</span><br><span class="line">        <span class="number">1000</span> .eh_frame</span><br><span class="line">        <span class="number">1000</span> .idata</span><br><span class="line">        <span class="number">1000</span> .rdata</span><br><span class="line">        <span class="number">3000</span> .text</span><br><span class="line">        <span class="number">1000</span> .tls</span><br></pre></td></tr></table></figure>
<h3 id="strings"><a href="#strings" class="headerlink" title="strings"></a>strings</h3><p>-t 显示字符的文件偏移</p>
<p>-a 使得strings扫描整个文件，而非只有文件中可加载的、经初始化的部分</p>
<p>-e 搜素其他字符编码，如Unicode</p>
<p>几乎不会用到的工具：x86流式反汇编器，ndisasm和diStorm。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/Notes/Win32_01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/Notes/Win32_01/" class="post-title-link" itemprop="url">Windows汇编语言基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-18 14:58:58" itemprop="dateCreated datePublished" datetime="2023-07-18T14:58:58+08:00">2023-07-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-02 16:33:58" itemprop="dateModified" datetime="2023-08-02T16:33:58+08:00">2023-08-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Notes/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="x86汇编语法"><a href="#x86汇编语法" class="headerlink" title="x86汇编语法"></a>x86汇编语法</h2><ul>
<li>AT&amp;T：GNU工具（Gas：GNU汇编器、gcc、gdb)         <ul>
<li>前缀：%reg,$立即数</li>
<li>操作数排序：mov 源操作数,目的操作数  add $0x4,%eax</li>
</ul>
</li>
<li>Intel ：MASM(微软汇编器)、Turbo汇编器、NASM<ul>
<li>add eax,0x4</li>
</ul>
</li>
</ul>
<p>.model flat，平坦模式，代码段和数据段共用一个4G段。</p>
<h2 id="局部变量、"><a href="#局部变量、" class="headerlink" title="局部变量、"></a>局部变量、</h2><p><strong>局部变量是堆栈变量</strong>。作用域是单个子程序，从子程序返回到主程序时被释放。一种规范写法是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL @buffer[10]:BYTE ;LOCAL 变量名1[重复数量]:类型,变量名2[重复数量]:类型</span><br></pre></td></tr></table></figure>
<p><code>LOCAL</code>用于为堆栈变量预留空间。</p>
<p>局部变量：只能在过程中用，主程序里不能用；</p>
<p>堆栈变量：没有初始值，只在调用时分配。C语言中的函数值传递的本质。</p>
<h2 id="一些常用类型整理"><a href="#一些常用类型整理" class="headerlink" title="一些常用类型整理"></a>一些常用类型整理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">byte db,word dw,DWORD dd,fword df,QWORD dq,tbyte dt  1,2,4,6,8,10</span><br><span class="line">WNDCLASS</span><br></pre></td></tr></table></figure>
<ul>
<li>TYPE返回变量大小</li>
<li>LENGTHOF  返回变量元素个数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">;,用于表示一个变量是否结束</span><br><span class="line">var6 dw 10,20,30,40,50</span><br><span class="line">	 dw 60,70,80,90,99</span><br><span class="line">var7 dw 10,20,30,40,50,</span><br><span class="line">	    60,70,80,90,99	 </span><br><span class="line">LENGTHOF var6 ;5</span><br><span class="line">LENGTHOF var7 ;10</span><br></pre></td></tr></table></figure>
<ul>
<li>SIZE，SIZEOF返回所占字节数=LENGTHOF*TYPR</li>
</ul>
<h2 id="1-和EQU伪指令"><a href="#1-和EQU伪指令" class="headerlink" title="1.=和EQU伪指令"></a>1.=和EQU伪指令</h2><p>由等号或者EQU定义的符号常量<strong>不占用存储空间。</strong></p>
<p>EQU类似于等号伪指令，但是EQU伪指令不许重复定义，而等号伪指令可以（同一个常量名可重复定义多次）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">presskey EQU &lt;&quot;Output is:&quot;&gt;</span><br><span class="line">.data</span><br><span class="line">propt db presskey</span><br></pre></td></tr></table></figure>
<h2 id="2-当前地址运算符"><a href="#2-当前地址运算符" class="headerlink" title="2.$ 当前地址运算符"></a>2.$ 当前地址运算符</h2><h2 id="3-LEA伪指令"><a href="#3-LEA伪指令" class="headerlink" title="3.LEA伪指令"></a>3.LEA伪指令</h2><p>OFFSET和ADDR编译时起作用，LEA是指令，在运行时起作用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV ESI,ADDR BVAL  ;相当于</span><br><span class="line">LEA ESi,BVAL</span><br></pre></td></tr></table></figure>
<p>计算堆栈（程序执行是分配）变量的偏移地址时，只能用lea。</p>
<h2 id="4-PTR-操作符"><a href="#4-PTR-操作符" class="headerlink" title="4.PTR 操作符"></a>4.PTR 操作符</h2><p>按照指定类型在内存中读写值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LIST DB 12H,34H,56H,78H;</span><br><span class="line">MOV EAX,DWORD PTR LIST ;EAX  78563412H</span><br></pre></td></tr></table></figure>
<h2 id="5-ALIGN和EVEN伪指令"><a href="#5-ALIGN和EVEN伪指令" class="headerlink" title="5.ALIGN和EVEN伪指令"></a>5.ALIGN和EVEN伪指令</h2><blockquote>
<p>CPU处理偶数地址比处理奇数地址要快。 可以在一个内存访问周期内获取该数据 </p>
</blockquote>
<p>ALIGN 对齐 (1,2,4)  按照n个字节的边界值对齐</p>
<p>EVEN  使下一地址从偶数地址开始</p>
<h2 id="6-TYPEDEF和TYPEDEF-PTR操作符"><a href="#6-TYPEDEF和TYPEDEF-PTR操作符" class="headerlink" title="6.TYPEDEF和TYPEDEF PTR操作符"></a>6.TYPEDEF和TYPEDEF PTR操作符</h2><p>类型自命名和定义指针的类型，<strong>不占用存储空间</strong></p>
<h2 id="7-LABEL伪指令"><a href="#7-LABEL伪指令" class="headerlink" title="7.LABEL伪指令"></a>7.LABEL伪指令</h2><p>别名，<strong>不占用存储空间</strong></p>
<h2 id="8-基数控制伪指令RAIDX"><a href="#8-基数控制伪指令RAIDX" class="headerlink" title="8.基数控制伪指令RAIDX"></a>8.基数控制伪指令RAIDX</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.RADIX  16;默认该指令后面的数据都是16进制数，其他进制的数据需要额外说明</span><br><span class="line"></span><br><span class="line">MOV AX,0FF ;十六进制数,对应十进制255</span><br><span class="line">MOV BX ,12D ;十进制数12</span><br></pre></td></tr></table></figure>
<p>9.ORG伪指令</p>
<p>10.REPT伪指令</p>
<h2 id="11-ASSUME伪指令"><a href="#11-ASSUME伪指令" class="headerlink" title="11.ASSUME伪指令"></a>11.ASSUME伪指令</h2><p>将程序的段与逻辑段绑定。</p>
<h2 id="12-SHORT伪指令"><a href="#12-SHORT伪指令" class="headerlink" title="12.SHORT伪指令"></a>12.SHORT伪指令</h2><h2 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.while(条件)</span><br><span class="line">.endw</span><br><span class="line"></span><br><span class="line">.repeat</span><br><span class="line"></span><br><span class="line">until(条件)</span><br><span class="line"></span><br><span class="line">.if </span><br><span class="line">.elseif</span><br><span class="line">.endif</span><br><span class="line">.break .if ;退出循环</span><br><span class="line">.continue ;结束本次循环，进入下一次循环</span><br></pre></td></tr></table></figure>
<h2 id="14-结构体和共用体"><a href="#14-结构体和共用体" class="headerlink" title="14.结构体和共用体"></a>14.结构体和共用体</h2><h2 id="15-宏定义"><a href="#15-宏定义" class="headerlink" title="15.宏定义"></a>15.宏定义</h2><h2 id="16-过程"><a href="#16-过程" class="headerlink" title="16.过程"></a>16.过程</h2><p>模块化代码</p>
<p>PROC [NEAR] 或者[FAR]，默认近调用，即在ODS实模式下的一个段里(&lt;64KB(。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">主程序中 CALL &#123;PROC_noarg_name&#125;</span><br><span class="line"></span><br><span class="line">PUSH 参数2</span><br><span class="line">PUSH 参数1</span><br><span class="line">INVOKE &#123;PROC_noarg_name&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;PROC_noarg_name&#125; PROC [NEAR]</span><br><span class="line">	LOCAL 变量名1[重复数量]:类型,变量名2[重复数量]:类型</span><br><span class="line">	RET   ;从栈中弹出返回地址，返回到主程序</span><br><span class="line">&#123;PROC_noarg_name&#125; ENDP	</span><br><span class="line"></span><br><span class="line">&#123;PROC_name&#125; PROC,参数1:类型,参数2:类型,...</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="17-ENTER和LEAVE"><a href="#17-ENTER和LEAVE" class="headerlink" title="17.ENTER和LEAVE"></a>17.ENTER和LEAVE</h2><h2 id="18-RET和RETN"><a href="#18-RET和RETN" class="headerlink" title="18.RET和RETN"></a>18.RET和RETN</h2><h2 id="19-IDA的反汇编"><a href="#19-IDA的反汇编" class="headerlink" title="19.IDA的反汇编"></a>19.IDA的反汇编</h2><h2 id="0day-安全"><a href="#0day-安全" class="headerlink" title="0day 安全"></a>0day 安全</h2><p> 文件偏移地址 = 虚拟内存地址（VA）−装载基址（Image Base）−节偏移<br>= RVA -节偏移 </p>
<p>对于 栈桢可能发生移位的情况 </p>
<h2 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h2><p> 一个函数返回时，esp正好指向原来存储返回地址的下一位，我们将shellcode从ret_addr的后一个位置开始填充，并将ret_addr填充为一个进程中的”jmp esp”的指令的地址，这样函数返回后就会跳到esp指向的栈顶的位置开始执行shellcode。 </p>
<p>缓冲区组成方式，现阶段已经讲了两种：</p>
<ol>
<li>将shellcode放到缓冲区，然后覆盖返回地址到缓冲区的起始地址。这种适用于缓冲区较大的场合。</li>
<li><p>将shellcode放到函数返回地址以后，然后覆盖返回地址为”jmp esp”之类的指令，使得函数返回时跳转到shellcode处执行指令。这种适用于缓冲区较小的场合。</p>
</li>
<li><p>找到程序运行的线程环境块TEB。</p>
</li>
<li>TEB的起始地址偏移0x30的地方指向进程环境块PEB。</li>
<li>PEB的地址偏移0x0C的地方存放指向PEB_LDR_DATA结构体的指针，该指针指向一个存放着被进程装载的动态链接库的信息的结构体。</li>
<li>PEB_LDR_DATA结构体偏移位置位0x1C的地方指向模块初始化链表的头指针InInitializationOrderModuleList。</li>
<li>4中的链表存放PE被载入时初始化的模块信息，第一个链表节点时ntdll.dll，第二个位kernel32.dll。</li>
<li>kernel32.dll的节点偏移0x08是kernel32.dll在内存中载入的基址。</li>
<li>kernel32.dll的基址加0xe3C是PE头的地址。</li>
<li>PE头偏移0x78存放着指向函数导出表的指针。</li>
<li>安照下述方法寻址：<ul>
<li>导出表偏移0x1C的指针指向存储导出函数偏移地址（RVA）的列表。</li>
<li>导出表偏移0x20指针指向存储导出函数名的列表。</li>
<li>根据函数名找到我们要的函数是导出表中的第几个，然后再地址列表中找到对应RVA。</li>
<li>RVA加上动态链接库的基址即是VA，这个也是我们在shellcode中需要的地址。</li>
</ul>
</li>
</ol>
<p>这里shellcode的构造为了尽可能的短，所以需要给每个API名字用一个hash去代替。<br>MessageBoxA：0x1e380a6a<br>ExitProcess：0x4fd18963<br>LoadLibraryA：0x0c917432</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">push 0x1e380a6a</span><br><span class="line">push 0x4fd18963 </span><br><span class="line">push 0x0c917432</span><br><span class="line">mov esi,esp</span><br><span class="line">lea edi,[esi-0xC]</span><br></pre></td></tr></table></figure>
<h2 id="如何实现一款-shellcodeLoader"><a href="#如何实现一款-shellcodeLoader" class="headerlink" title="如何实现一款 shellcodeLoader"></a>如何实现一款 shellcodeLoader</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1755926">https://cloud.tencent.com/developer/article/1755926</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://blueinyou.com/categories/CTF/Windows01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blueinyou.com/photos/avatar.jpg">
      <meta itemprop="name" content="Paul C">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Paul C's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/categories/CTF/Windows01/" class="post-title-link" itemprop="url">MITRE ATT&CK™ 矩阵</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-16 14:19:49" itemprop="dateCreated datePublished" datetime="2023-07-16T14:19:49+08:00">2023-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-29 11:16:34" itemprop="dateModified" datetime="2023-08-29T11:16:34+08:00">2023-08-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文记录那些恶意软件使用的关键API。</p>
<p>NtProtectVirtualMemory ,创建PAGE_GUARD属性的内存页，通常用于反逆向和反调试 ； 将可读可写的内存属性改为可读可执行 。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Paul C"
      src="https://blueinyou.com/photos/avatar.jpg">
  <p class="site-author-name" itemprop="name">Paul C</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">179</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/memoryofsnow" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;memoryofsnow" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2215489940@qq.com" title="E-Mail → mailto:2215489940@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/jiyi_guoshu" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;jiyi_guoshu" rel="noopener" target="_blank"><i class="fab fa-csdn fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Paul C</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
